# 匿名BOT 機能追加・アーキテクチャ刷新に関する引き継ぎ書

## 1. 概要

本ドキュメントは、匿名BOTの機能追加およびセキュリティアーキテクチャの全面的な刷新に関する、実装タスクの引き継ぎ書です。これまでの議論で決定した最終的な仕様と、具体的な実装手順を記載します。

## 2. 追加・変更される機能

1.  **BOTオーナー向けグローバル追跡機能:**
    *   BOTオーナーが、全サーバーを横断して特定のユーザーの投稿を高速に検索・追跡できる新しいコマンド (`/global_trace`, `/global_user_posts`) を実装します。`/global_trace` はメッセージIDから投稿者を、`/global_user_posts` はユーザーから投稿を検索します。
2.  **暗号化アーキテクチャの刷新:**
    *   セキュリティと匿名性を最高レベルに高めるため、暗号化および署名の方式を全面的に刷新します。
3.  **マスターキーのローテーション機能:**
    *   将来的なキーの変更に備え、ダウンタイムなしで安全にマスターキーをローテーションできる仕組みを導入します。
4.  **Config機能の改善:**
    *   レート制限のタイムスロットをConfigで設定可能にします。
    *   グローバルチャット関連の設定項目を追加し、専用のコマンドグループに分離します。
    *   設定表示コマンドの軽微なバグを修正します。
5.  **（オプション）キー洗い替え機能:**
    *   古いマスターキーで暗号化されたデータを、新しいキーで再暗号化するための管理者向けバッチ処理を実装します。

## 3. 最終的なアーキテクチャ

### 3.1. `anonymous_posts` テーブル

投稿の永続的な記録。追跡に繋がりうる一貫した署名を一切保存しない設計に変更します。

*   `id`: 主キー
*   `guild_id`: サーバーID
*   `channel_id`: チャンネルID
*   `message_id`: メッセージID
*   `user_id_encrypted` (TEXT): 暗号化されたユーザーID。
*   `encryption_salt` (TEXT): 上記の暗号化に使った、**投稿ごとにユニークな鍵導出用Salt。**
*   `search_tag` (TEXT): サーバー管理者が検索するための署名。**投稿ごとに毎回異なる値**になる。ユーザー検索時は、ブルームフィルタで絞り込んだ後の最終検証に利用する。
*   `global_user_signature` (TEXT): BOTオーナーが `/global_user_posts` で検索するための署名。**投稿ごとに毎回異なる値**になるように変更。
*   `key_version` (INTEGER): 暗号化に使用したマスターキーのバージョン番号。
*   `content`: 投稿内容
*   ... (その他のメタデータ)

**削除されるカラム:** `daily_user_id_signature`

### 3.2. `rate_limits` テーブル

レート制限のためだけの一時的な記録。

*   `rate_limit_key` (TEXT): `HMAC(key=サーバー秘密鍵, data=ユーザーID + 日付)`で生成される、**その日限り有効な**ユーザー識別キー。
*   `timestamp` (DATETIME): 投稿時刻。

### 3.3. `global_chat_events` テーブル (新規追加)

グローバルチャットの投稿イベントとメッセージ転送を関連付けるためのテーブル。DB負荷をスケールさせるための要です。

*   `original_message_id` (TEXT): 主キー。最初に投稿されたメッセージのID。
*   `user_id_encrypted` (TEXT): 投稿者の暗号化済みユーザーID。追跡を高速化するために冗長に保存。
*   `forwarded_map` (JSONB): `{"転送先サーバーID": "転送先メッセージID", ...}` の形式で、全ての転送先情報を格納するマップ。GINインデックスを作成し、値による高速な検索を可能にする。
*   `status` (TEXT): イベントの状態（例: `PENDING`, `COMPLETED`）。
*   `created_at` (DATETIME): イベント作成日時。

### 3.4. 暗号化・署名の詳細

*   **ユーザーIDの暗号化:** マスターキーと投稿ごとの`encryption_salt`から導出したユニークな鍵で暗号化する。
*   **`search_tag`の生成:** `HMAC(key=サーバー秘密鍵, data=ユーザーID + 投稿ごとのユニークなノンス)`
*   **`global_user_signature`の生成:** `HMAC(key=マスターキー + ペッパー, data=ユーザーID + 投稿ごとのユニークなノンス)`

## 4. 実装TODOリスト

以下の順番で実装を進めることを推奨します。

1.  **Configシステムの拡張とバグ修正 (`src/cogs/config.py`):**
    *   `DEFAULT_SETTINGS`に`rate_limit_timeslot`を追加。
    *   `/config`コマンドの一覧表示で、`embed.add_field`の`name`引数に`key`を使用するよう修正。
2.  **データベースモデルの変更 (`src/models.py`):**
    *   `AnonymousPost`モデルから`daily_user_id_signature`を削除し、`encryption_salt`, `global_user_signature`, `key_version`を追加。
    *   `RateLimit`モデルを新しい仕様に変更。
    *   **`GlobalChatEvents`モデルを新規作成。**
3.  **データベースマイグレーションスクリプトの生成と適用 (`alembic`):**
    *   `alembic revision --autogenerate`でマイグレーションスクリプトを生成し、内容を確認・調整後、`alembic upgrade head`で適用する。
4.  **暗号化ユーティリティの刷新 (`src/utils/crypto.py`):**
    *   マスターキーの多版管理に対応。`.env`から`ENCRYPTION_KEY_X`と`CURRENT_KEY_VERSION`を読み込むようにする。
    *   ペッパーを導入。
    *   新しいアーキテクチャに基づいた暗号化・復号・署名生成関数を実装する。
5.  **投稿処理の全面的な書き換え (`src/cogs/anonymous_post.py`):**
    *   グローバルチャット機能が有効なチャンネルでのメッセージ投稿時に`GlobalChatEvents`レコードを作成する処理を追加。
    *   グローバルチャットへの転送処理を非同期タスク化し、完了後に`GlobalChatEvents`の`forwarded_map`を更新するよう変更。
    *   `anonymous_posts`テーブルに新しい形式でデータを保存するようにする。
6.  **レート制限処理の分離と実装:**
    *   投稿処理の中で、新しい`rate_limits`テーブルの仕様に基づいてレート制限チェックを行うようにする。
7.  **`rate_limits`テーブルの自動クリーンアップ処理の実装:**
    *   日付が変わった際などに、古いレート制限データを削除するバックグラウンドタスクを実装する。
8.  **既存のサーバー管理者向け検索機能の改修 (`src/cogs/moderation.py`):**
    *   `/trace`コマンドはメッセージID検索のため、大きな変更はない。
    *   `/user_posts`コマンドは、DB負荷を最小限に抑えつつ高い匿名性を維持するため、**ブルームフィルタ**を活用した新しい検索方式に全面的に改修する。
        1.  まず、指定された期間内の全投稿の`message_id`と`search_tag`をDBから取得する。
        2.  次に、検索対象ユーザーのIDと検索期間内のタイムスタンプ（例: YYYY-MM-DD-HH）から大量の検索用署名をクライアントサイドで生成し、ブルームフィルタを構築する。
        3.  DBから取得した投稿リストを、このブルームフィルタを使ってメモリ上で高速にフィルタリングし、候補を数十件程度に絞り込む。
        4.  最後に、絞り込まれた候補に対してのみ`search_tag`の厳密な検証を行い、最終的な結果を得る。
9.  **BOTオーナー向けグローバル検索コマンドの実装 (`src/cogs/moderation.py`):**
    *   BOTオーナー専用の`/global_trace`, `/global_user_posts`を新設する。
    *   `/global_trace`は`GlobalChatEvents`テーブルを利用してメッセージIDから投稿者を特定するロジックを実装する。
    *   `/global_user_posts`は、`/user_posts`と同様にブルームフィルタを活用した検索方式を実装する。`global_user_signature`を`search_tag`と同様に扱い、BOTオーナーのマスターキーとペッパーで署名を検証する。
10. **グローバルチャット用Configコマンドの新設:**
    *   グローバルチャット関連の設定（レート制限、匿名IDフォーマット等）を管理するための専用コマンドグループ `/globalconfig` を作成する。
11. **（オプション）暗号キー洗い替え用の管理者向けバッチ処理の実装:**
    *   古いキーバージョンのデータを最新キーで再暗号化するコマンドまたはスクリプトを実装する。
12. **全面的な動作テストとドキュメント更新:**
    *   すべての機能が正しく動作することを確認する。
    *   `README.md`や`docs/`以下の関連ドキュメントを更新する。

以上