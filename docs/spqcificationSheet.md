# Discord Bot 実装仕様書

## 1. 概要

このドキュメントは、Discord Botの管理機能およびログ機能を強化するための改修仕様を定義する。
主な改修点は、`user_posts`, `trace`, `admin_logs` コマンドの機能拡張と、それに伴うデータベースの変更、全体的なエラーハンドリングとロギングの強化である。

---

## 2. データベースの変更 (`models.py`)

### 2.1. `AdminCommandLog` テーブルへのカラム追加

`admin_logs` コマンドの検索結果を記録するため、以下のカラムを追加する。

-   `success`: `Boolean`型, `nullable=False`, `default=True`
    -   コマンドの実行が成功したか（ユーザーが見つからない場合などは `False`）を記録する。

---

## 3. コマンドの改修 (`cogs/moderation.py`)

### 3.1. `user_posts` コマンド

指定したユーザーの匿名投稿を検索する機能を拡張する。

#### 3.1.1. 引数の追加

-   `deleted_status`: `Enum`型 (選択肢: `すべて`, `削除済みのみ`, `削除済みを除く`), `default='削除済みを除く'`
    -   検索対象に削除済みのメッセージを含めるかどうかを指定する。

#### 3.1.2. 機能変更

-   **表示順**: 投稿が古い順（昇順）ではなく、新しい順（降順）で表示する。
-   **ページネーション**: 結果を10件ずつ表示するページネーションを実装する。
-   **Embed表示の改善**:
    -   Embedのフッターに `ページ X/Y` のように現在のページと総ページ数を表示する。
    -   削除済みのメッセージは、タイトルに `(削除済み)` と追記し、内容に取り消し線を入れるなど、視覚的に分かりやすく表示する。
    -   フィールドの値をより詳細にする。
        -   投稿日時 (`YYYY-MM-DD HH:MI:SS`)
        -   チャンネル名
        -   メッセージへのリンク
        -   匿名ID
        -   誤投稿変換の有無 (`is_converted`)
        -   添付ファイルのURLリスト

### 3.2. `trace` コマンド

メッセージIDから投稿者を特定する機能に、追加情報を表示する。

#### 3.2.1. 表示情報の追加

現在の投稿者情報に加え、以下の情報をEmbedにフィールドとして追加する。

-   **投稿日時**: `YYYY-MM-DD HH:MI:SS`
-   **誤投稿変換**: `あり` / `なし`
-   **アカウント作成日時**: `YYYY-MM-DD HH:MI:SS` (`作成からX日`)
-   **サーバー参加日時**: `YYYY-MM-DD HH:MI:SS` (`参加からX日`)

### 3.3. `admin_logs` コマンド

管理コマンドの実行ログを表示する機能を拡張する。

#### 3.3.1. 引数の変更・追加

-   `command_name`: `Enum`型にし、BOTに実装されている管理コマンドをDiscord側で補完できるようにする。
-   `target_user`: `discord.User`型, `optional`
    -   コマンドの対象となったユーザーでログを絞り込めるようにする。

#### 3.3.2. 機能変更

-   **表示順**: 実行日時が新しい順（降順）で表示する。
-   **ページネーション**: 結果を10件ずつ表示するページネーションを実装する。
-   **Embed表示の改善**:
    -   Embedのフッターに `ページ X/Y` のように現在のページと総ページ数を表示する。
    -   フィールドに以下の情報を追加する。
        -   **実行者**: `@user (user_id)`
        -   **対象者**: `@user (user_id)` (もしあれば)
        -   **実行日時**: `YYYY-MM-DD HH:MI:SS`
        -   **成功/失敗**: `Success` / `Failure` (`success` カラムの値に基づく)

---

## 4. エラーハンドリングとロギング

### 4.1. 対象範囲

-   今回改修する `user_posts`, `trace`, `admin_logs` コマンド。
-   その他、関連する `cogs/anonymous_post.py` 内の処理。

### 4.2. 実装内容

-   **エラーハンドリング**:
    -   `try-except` ブロックを適切に配置し、予期せぬエラーが発生した場合でもBOTが停止しないようにする。
    -   ユーザーへのエラー通知は、より具体的で分かりやすいメッセージ（例：「指定されたユーザーが見つかりませんでした。」）をephemeralで返信する。
-   **ロギング**:
    -   `logging` モジュールを使用し、DB (`BotLog`テーブル) にログを記録する。
    -   **記録する情報**:
        -   コマンドの実行開始・終了
        -   エラー発生時の詳細な情報（トレースバックを含む）
        -   データベース操作の成功・失敗
    -   ログレベルを適切に使い分ける (`INFO`, `WARNING`, `ERROR`, `CRITICAL`)。

---

## 5. その他

-   コード全体において、可読性と保守性を向上させるためのリファクタリングを適宜行う。
-   環境変数や設定値は、`cogs/config.py` を通じて取得するように統一する。